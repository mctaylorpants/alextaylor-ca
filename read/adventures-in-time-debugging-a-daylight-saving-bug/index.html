<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Nanoc 4.12.2">

    <title>alextaylor.ca - Adventures in Time: Debugging a Daylight Saving Bug</title>

    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css" integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">
    <link rel="stylesheet" href="/stylesheet.css">
    <link rel="stylesheet" href="/code-highlighting.css">

    <!-- favicon generated by https://favicon.io/favicon-generator/ -->
    <!-- Font Copyright (c) 2010-2012, Vernon Adams (vern@newtypography.co.uk), with Reserved Font Names "Coda" -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta property="og:site_name" content="alextaylor.ca" />
    <meta property="og:type" content="article" />

    
      <meta property="og:image" content="https://alextaylor.ca/images/taylormade_og_image.png" />
      <meta property="og:title" content="Adventures in Time: Debugging a Daylight Saving Bug" />
      <meta property="og:description" content="What’s more fun than bugs? Bugs involving time! And none are so fascinating as bugs involving daylight saving time.

With Daylight saving time almost upon us again, I thought it would be fun to rev..." />
      <meta property="og:url" content="https://alextaylor.ca/read/adventures-in-time-debugging-a-daylight-saving-bug/" />
      <meta name="twitter:card" content="summary_large_image"></meta>
    
  </head>
  <body>
    <div class="pure-g">
      <div class="pure-u-1 header">
        <div class="l-box">
          <h1>
            <a href="/">
              <span class="light">~/</span>taylormade
            </a>
          </h1>
          <hr />
        </div>
      </div>

      <div class="pure-u-1 content">
        <div class="l-box">
          
            <h1>Adventures in Time: Debugging a Daylight Saving Bug</h1>
            <p class="post-meta">
              March 4, 2023
            </p>
          

          <p>What’s more fun than bugs? Bugs involving time! And none are so fascinating as bugs involving <em>daylight saving time.</em></p>

<p>With Daylight saving time almost upon us again, I thought it would be fun to revisit this bug I stumbled across last fall.</p>

<h2 id="once-upon-a-time">
<a href="#once-upon-a-time"></a>Once upon a time…</h2>
<p>When subscribing a customer to a monthly plan in our billing system, we calculate the date of their next bill by adding 30 days to the current time, and using that to create a subscription on Stripe.</p>

<p>However, at some point in October, we started to see this fail:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Stripe</span><span class="o">::</span><span class="no">InvalidRequestError</span><span class="p">:</span> 
  <span class="n">billing_cycle_anchor</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">later</span> <span class="n">than</span> <span class="k">next</span>
  <span class="n">natural</span> <span class="n">billing</span> <span class="n">date</span> <span class="p">(</span><span class="mi">1669817382</span><span class="p">)</span> <span class="k">for</span> <span class="n">plan</span>
</code></pre></div></div>

<p>When comparing the “natural billing date” to the time we sent the request, it was indeed more than 30 days in the future – by exactly an hour. Curious!</p>

<h2 id="arithmetick-tock-">
<a href="#arithmetick-tock-"></a>Arithmetick-tock ⏰</h2>

<p>In the code, we were doing something roughly like this to calculate the billing date:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">subscription</span><span class="p">.</span><span class="nf">started_at</span> <span class="o">+</span> <span class="mi">30</span><span class="p">.</span><span class="nf">days</span>
</code></pre></div></div>

<p><code>started_at</code> is a <code>Time</code> object, and we’re using the <code>ActiveSupport::Duration</code> helpers to advance that time by exactly 30 days. So what’s the issue?</p>

<p>I fired up a console and started poking at this particular line of code to learn how it behaved.</p>

<p>First, a sanity-check: I want to make sure I know that <code>.days</code> is giving me what I expect:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vg">$&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2022-10-15 12:00:00 -0700"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span>
<span class="o">=&gt;</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">16</span> <span class="mi">12</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">-</span><span class="mo">0700</span>

<span class="vg">$&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2022-10-15 12:00:00 -0700"</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">16</span> <span class="mi">12</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">-</span><span class="mo">0700</span>
</code></pre></div></div>

<p>Ok, good! I get the same answer if I add the total number of seconds in a day. Makes sense.</p>

<p>Now, what happens if I do the same thing, but add 30 days?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vg">$&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2022-10-15 12:00:00 -0700"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">30</span><span class="p">.</span><span class="nf">days</span>
<span class="o">=&gt;</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">14</span> <span class="mi">12</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">-</span><span class="mi">0800</span>

<span class="vg">$&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2022-10-15 12:00:00 -0700"</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">14</span> <span class="mi">11</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span> <span class="o">-</span><span class="mi">0800</span>
</code></pre></div></div>

<p>Aha! There’s our bug. Depending on whether I use a <code>Duration</code> object or plain old seconds, I get a different answer. This feels like a daylight saving issue, since we’re crossing the boundary here, and our two times disagree by <em>exactly</em> an hour.</p>

<p>Next, I want to test my hypothesis that this has something to do with crossing the daylight saving boundary. Let’s try the same test, but using a time that’s right before the boundary. Daylight saving ended on November 6, 2022 at 2am, so let’s start from 1 second before and add 1 day:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vg">$&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2022-11-06 01:59:59 -0700"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span>
<span class="o">=&gt;</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">07</span> <span class="mo">01</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span> <span class="o">-</span><span class="mi">0800</span>

<span class="vg">$&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2022-11-06 01:59:59 -0700"</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">07</span> <span class="mo">00</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">59</span> <span class="o">-</span><span class="mi">0800</span>
</code></pre></div></div>

<p>Still behaves the same. So we can confidently say that <strong>when crossing the DST boundary, adding a Duration to a timestamp yields a different time than adding a number of seconds.</strong></p>

<h2 id="testing-the-hypothesis">
<a href="#testing-the-hypothesis"></a>Testing the hypothesis</h2>

<p>So which of the two answers above is correct?</p>

<p>It’s easier to answer that question with a shorter duration, so let’s work with plain seconds:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vg">$&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2022-11-06 01:59:59 -0700"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>
<span class="o">=&gt;</span> <span class="mi">2022</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mo">06</span> <span class="mo">01</span><span class="p">:</span><span class="mo">00</span><span class="p">:</span><span class="mo">04</span> <span class="o">-</span><span class="mi">0800</span>
</code></pre></div></div>

<p>This makes sense:</p>

<ul>
  <li>We added 5 seconds to get to 02:00:04.</li>
  <li>Since daylight saving ended at 2am, we roll the clock back by 1 hour.</li>
  <li>We end up with 01:00:04, in GMT -8 instead of GMT -7.</li>
</ul>

<p>Numbers don’t lie, but it seems like <code>ActiveSupport::Duration</code> may be stretching the truth in this case.</p>

<p>So why does <code>1.day</code> behave so differently?</p>

<h2 id="down-the-rabbit-hole">
<a href="#down-the-rabbit-hole"></a>Down the rabbit hole</h2>

<p>In order to explain the bug, we need some context on what happens when we add these two values together. Remember, since everything in Ruby is an object, an operation like <code>2 + 1</code>  is really invoking the <code>+</code> method on <code>2</code>, and passing <code>1</code> as an argument.</p>

<p>ActiveSupport implements methods like <code>+</code> on <code>Duration</code> objects so that you can add two of them together:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vg">$&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span>
<span class="o">=&gt;</span> <span class="mi">2</span> <span class="n">days</span>
</code></pre></div></div>

<p>That’s all fine and good when you have two <code>Duration</code> objects, or at least when a <code>Duration</code> object is the receiver (on the left-hand side of the operation). But we’ve got a plain ol’ Ruby class on the left:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Time</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="s2">"2022-11-06 01:59:59 -0700"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">.</span><span class="nf">day</span>
</code></pre></div></div>

<p>Here, we know the <code>+</code> method is being invoked on our <code>Time</code> object, yet somehow it knows what to do with an <code>ActiveSupport::Duration</code>. How is that possible? Let’s introspect <code>+</code> and see where it takes us:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vg">$&gt;</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">method</span><span class="p">(:</span><span class="o">+</span><span class="p">)</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Method: Time#+(plus_with_duration)(other) /ruby/gems/2.7.0/gems/activesupport-5.2.8.1/lib/active_support/core_ext/time/calculations.rb:261&gt;</span>
<span class="c1"># active_support/core_ext/time/calculations.rb:261</span>
</code></pre></div></div>

<p>Hey, look! A monkey patch! 🙈</p>

<p><a href="https://github.com/rails/rails/blob/8030cff808657faa44828de001cd3b80364597de/activesupport/lib/active_support/core_ext/time/calculations.rb#L261-L269">Let’s peek at that code</a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">plus_with_duration</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
  <span class="k">if</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Duration</span> <span class="o">===</span> <span class="n">other</span>
    <span class="n">other</span><span class="p">.</span><span class="nf">since</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">else</span>
    <span class="n">plus_without_duration</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="kp">alias_method</span> <span class="ss">:plus_without_duration</span><span class="p">,</span> <span class="p">:</span><span class="o">+</span>
<span class="kp">alias_method</span> <span class="p">:</span><span class="o">+</span><span class="p">,</span> <span class="ss">:plus_with_duration</span>
</code></pre></div></div>

<p>Here, ActiveSupport has hooked into <code>+</code> to customize the path taken if the value being added is a <code>Duration</code> class. Otherwise, we can fall back on the original <code>+</code> method.</p>

<p>This is the point where I break out a debugger like <a href="https://github.com/pry/pry">pry</a> to step through the code and see where it takes me. After <code>step</code>ping into <code>#since</code> and following the code path, <a href="https://github.com/rails/rails/blob/8030cff808657faa44828de001cd3b80364597de/activesupport/lib/active_support/core_ext/time/calculations.rb#L175">I end up here</a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_advanced_by_date</span> <span class="o">=</span> <span class="n">change</span><span class="p">(</span><span class="ss">year: </span><span class="n">d</span><span class="p">.</span><span class="nf">year</span><span class="p">,</span> <span class="ss">month: </span><span class="n">d</span><span class="p">.</span><span class="nf">month</span><span class="p">,</span> <span class="ss">day: </span><span class="n">d</span><span class="p">.</span><span class="nf">day</span><span class="p">)</span>
</code></pre></div></div>

<p>Well, that’s interesting. Just looking at that method call, I can see that we’re dropping the hour, minute and second. And since I’m investigating a bug relating to an incorrect hour offset, this really piques my curiosity.</p>

<p>Let’s step down <a href="https://github.com/rails/rails/blob/8030cff808657faa44828de001cd3b80364597de/activesupport/lib/active_support/core_ext/time/calculations.rb#L120">one more level into <code>#change</code></a>, which lives in another monkey-patch on the <code>Time</code> class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">def</span> <span class="nf">change</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="n">new_year</span>   <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:year</span><span class="p">,</span> <span class="n">year</span><span class="p">)</span>
    <span class="n">new_month</span>  <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:month</span><span class="p">,</span> <span class="n">month</span><span class="p">)</span>
    <span class="n">new_day</span>    <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:day</span><span class="p">,</span> <span class="n">day</span><span class="p">)</span>
    <span class="n">new_hour</span>   <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:hour</span><span class="p">,</span> <span class="n">hour</span><span class="p">)</span>
    <span class="n">new_min</span>    <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:min</span><span class="p">,</span> <span class="n">options</span><span class="p">[</span><span class="ss">:hour</span><span class="p">]</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">min</span><span class="p">)</span>
    <span class="n">new_sec</span>    <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:sec</span><span class="p">,</span> <span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="ss">:hour</span><span class="p">]</span> <span class="o">||</span> <span class="n">options</span><span class="p">[</span><span class="ss">:min</span><span class="p">])</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">sec</span><span class="p">)</span>
    <span class="n">new_offset</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:offset</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>

    <span class="o">...</span>

    <span class="k">if</span> <span class="n">new_offset</span>
      <span class="o">::</span><span class="no">Time</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">new_year</span><span class="p">,</span> <span class="n">new_month</span><span class="p">,</span> <span class="n">new_day</span><span class="p">,</span> <span class="n">new_hour</span><span class="p">,</span> <span class="n">new_min</span><span class="p">,</span> <span class="n">new_sec</span><span class="p">,</span> <span class="n">new_offset</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">utc?</span>
      <span class="o">::</span><span class="no">Time</span><span class="p">.</span><span class="nf">utc</span><span class="p">(</span><span class="n">new_year</span><span class="p">,</span> <span class="n">new_month</span><span class="p">,</span> <span class="n">new_day</span><span class="p">,</span> <span class="n">new_hour</span><span class="p">,</span> <span class="n">new_min</span><span class="p">,</span> <span class="n">new_sec</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">zone</span>
      <span class="o">::</span><span class="no">Time</span><span class="p">.</span><span class="nf">local</span><span class="p">(</span><span class="n">new_year</span><span class="p">,</span> <span class="n">new_month</span><span class="p">,</span> <span class="n">new_day</span><span class="p">,</span> <span class="n">new_hour</span><span class="p">,</span> <span class="n">new_min</span><span class="p">,</span> <span class="n">new_sec</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="o">::</span><span class="no">Time</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">new_year</span><span class="p">,</span> <span class="n">new_month</span><span class="p">,</span> <span class="n">new_day</span><span class="p">,</span> <span class="n">new_hour</span><span class="p">,</span> <span class="n">new_min</span><span class="p">,</span> <span class="n">new_sec</span><span class="p">,</span> <span class="n">utc_offset</span><span class="p">)</span>
    <span class="k">end</span>
</code></pre></div></div>

<p><code>change</code> is finally the method which returns a new <code>Time</code> object based on the results of the operation. Ultimately, we’re calling some variant of <code>Time.new</code>, providing all-new values for the year, month, etc.</p>

<p>And where do we get all these new values?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">new_hour</span>   <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="ss">:hour</span><span class="p">,</span> <span class="n">hour</span><span class="p">)</span>
</code></pre></div></div>

<p>If we didn’t pass it in from the arguments, then we fall back <em>to the existing <code>hour</code>, <code>min</code> and <code>sec</code> value on the current <code>Time</code> object.</em></p>

<p>In other words, given our initial <code>Time</code> object of <code>Time.parse("2022-11-06 01:59:59 -0700")</code>, we’re going to add <code>1.day</code> to the date only, then pin <code>01:59:59</code> on the end of it.</p>

<p>And there’s our bug!</p>

<h2 id="spoiler-alert-its-fixed-already">
<a href="#spoiler-alert-its-fixed-already"></a>Spoiler alert: it’s fixed already</h2>

<p>As it turns out, <a href="https://github.com/rails/rails/issues/45055">this bug had been reported a few months prior</a>, and <a href="https://github.com/rails/rails/pull/46251">fixed shortly afterwards</a>.</p>

<p>Reading the fix was also illuminating, because it revealed more subtleties than I had considered in my initial debugging session. It turns out that I hadn’t considered how ActiveSupport is taking the time zone itself into account when performing this arithmetic. A humbling reminder that it’s always possible to get the right answer for the wrong reason.</p>

<p>One thing is clear, though: time is hard!</p>

<h2 id="the-end">
<a href="#the-end"></a>The end</h2>

<p>Ultimately, the workaround on our side was a simple 5-character change: do our math with seconds instead of a <code>Duration</code> object:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">subscription</span><span class="p">.</span><span class="nf">started_at</span> <span class="o">+</span> <span class="mi">30</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">to_i</span>
</code></pre></div></div>

<p>I always have a hard … ahem, <em>time</em> … wrapping my head around time-related bugs. This one was a fun opportunity to dive in and get to the bottom of a hairy problem.</p>

<p>Thanks for reading!</p>

        </div>
      </div>

      <div class="pure-u-1">
        <div class="l-box">
          <hr />
          <p class="footer">
            &copy; 2023 <strong>Alex Taylor</strong>
            &middot;
            <a href="https://github.com/mctaylorpants">github</a>
            &middot;
            <a href="https://www.linkedin.com/in/alexmorgantaylor/">linkedin</a>
            &middot;
            <a href="https://twitter.com/mctaylorpants">twitter</a>
            &middot;
            <a rel="me" href="https://ruby.social/@alextaylor">mastodon</a>
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
