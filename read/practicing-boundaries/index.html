<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Nanoc 4.12.2">

    <title>alextaylor.ca - Practicing boundaries</title>

    <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css" integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">
    <link rel="stylesheet" href="/stylesheet.css">
    <link rel="stylesheet" href="/code-highlighting.css">

    <!-- favicon generated by https://favicon.io/favicon-generator/ -->
    <!-- Font Copyright (c) 2010-2012, Vernon Adams (vern@newtypography.co.uk), with Reserved Font Names "Coda" -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta property="og:site_name" content="alextaylor.ca" />
    <meta property="og:type" content="article" />

    
      <meta property="og:image" content="https://alextaylor.ca/images/taylormade_og_image.png" />
      <meta property="og:title" content="Practicing boundaries" />
      <meta property="og:description" content="Code which is loosely-coupled is easier to work with. Itâ€™s easy to say, right? I find a lot of software patterns sound really nice, but it can be hard to apply them. And for that, examples always h..." />
      <meta property="og:url" content="https://alextaylor.ca/read/practicing-boundaries/" />
      <meta name="twitter:card" content="summary_large_image"></meta>
    
  </head>
  <body>
    <div class="pure-g">
      <div class="pure-u-1 header">
        <div class="l-box">
          <h1>
            <a href="/">
              <span class="light">~/</span>taylormade
            </a>
          </h1>
          <hr />
        </div>
      </div>

      <div class="pure-u-1 content">
        <div class="l-box">
          
            <h1>Practicing boundaries</h1>
            <p class="post-meta">
              January 20, 2022
            </p>
          

          <p>Code which is loosely-coupled is easier to work with. Itâ€™s easy to say, right? I find a lot of software patterns <em>sound</em> really nice, but it can be hard to apply them. And for that, examples always help!</p>

<p>Iâ€™ve been trying to pay more attention to this rule recently, and I found a good example yesterday in some code I was writing.</p>

<h2 id="how-it-started">
<a href="#how-it-started"></a>How it started</h2>
<p>Iâ€™m working on a feature that needs to accept a CSV containing rows of account details, and apply those changes to each account. Even from that simple sentence alone, a pretty obvious boundary emerges:</p>

<blockquote>
  <p><em>accept a CSV â€¦ <strong>and</strong> apply changes to each account</em></p>
</blockquote>

<p>If we decouple the CSV handling from the business logic for processing each row, weâ€™re in good shape.</p>

<p>Hereâ€™s what I started with (and no, we donâ€™t actually track our usersâ€™ favourite tea, but wouldnâ€™t that be nice ðŸ˜Œ):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ImportCsvController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">csv</span> <span class="o">=</span> <span class="no">CSV</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:file</span><span class="p">][</span><span class="ss">:content</span><span class="p">],</span> <span class="ss">headers: </span><span class="kp">true</span><span class="p">)</span>
    <span class="n">csv</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
      <span class="no">AccountUpdater</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">row</span><span class="p">).</span><span class="nf">update!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AccountUpdater</span>
  <span class="nb">attr_reader</span> <span class="ss">:row</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="vi">@row</span> <span class="o">=</span> <span class="n">row</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update!</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"Account Id"</span><span class="p">]</span>
    <span class="n">favourite_tea</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">"Favourite Tea"</span><span class="p">]</span>

    <span class="no">Account</span>
      <span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">account_id</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">favourite_tea: </span><span class="n">favourite_tea</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Here we can see the boundary in action: the controller handles the nitty-gritty of parsing the CSV file, and <code>AccountUpdater</code> just receives some data and updates the account.</p>

<p>But once I had finished and I was looking it over again, I realized I had still broken a boundary. Can you spot it?</p>

<h2 id="the-hidden-dependency">
<a href="#the-hidden-dependency"></a>The (hidden?) dependency</h2>
<p>It might look like <code>AccountUpdater</code> doesnâ€™t have a dependency on the CSV, but it absolutely does:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csv</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
  <span class="no">AccountUpdater</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">row</span><span class="p">).</span><span class="nf">update!</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In order to provide <code>AccountUpdater</code> with the data it needs, weâ€™re passing in the <code>row</code> that we parsed from the CSV. Since we used <a href="https://ruby-doc.org/stdlib-3.0.0/libdoc/csv/rdoc/CSV.html#method-c-parse"><code>CSV.parse</code></a> with the <code>headers</code> option, we at least get a nice Hash-like object to work withâ€¦</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="s2">"Account Id"</span> <span class="o">=&gt;</span> <span class="s2">"123"</span><span class="p">,</span> <span class="s2">"Favourite Tea"</span> <span class="o">=&gt;</span> <span class="s2">"Assam"</span> <span class="p">}</span>
</code></pre></div></div>

<p>â€¦ however, weâ€™re still leaking knowledge about the format of our CSV into <code>AccountUpdater</code>: it knows about our columns named <code>"Account Id"</code> and <code>"Favourite Tea"</code>.  We have subtly embedded knowledge about the structure of our user input into a class that should have no business handling user input.</p>

<h2 id="how-its-going">
<a href="#how-its-going"></a>How itâ€™s going</h2>
<p>As soon as I realized this, I pulled that knowledge back up into the controller:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">csv</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
  <span class="no">AccountUpdater</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
    <span class="ss">account_id: </span><span class="n">row</span><span class="p">[</span><span class="s2">"Account Id"</span><span class="p">],</span>
    <span class="ss">favourite_tea: </span><span class="n">row</span><span class="p">[</span><span class="s2">"Favourite Tea"</span><span class="p">]</span>
  <span class="p">).</span><span class="nf">update!</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AccountUpdater</span>
  <span class="nb">attr_reader</span> <span class="ss">:account_id</span><span class="p">,</span> <span class="ss">:favourite_tea</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">account_id</span><span class="p">:,</span> <span class="n">favourite_tea</span><span class="p">:)</span>
    <span class="vi">@account_id</span> <span class="o">=</span> <span class="n">account_id</span>
    <span class="vi">@favourite_tea</span> <span class="o">=</span> <span class="n">favourite_tea</span>
  <span class="k">end</span>

  <span class="o">...</span>
</code></pre></div></div>

<p>Now, weâ€™re using keyword arguments to create a simple boundary between the structure of the CSV data and the data that <code>AccountUpdater</code> needs.</p>

<h2 id="lessons-learned">
<a href="#lessons-learned"></a>Lessons learned</h2>
<p>By taking a closer look at our boundaries, we managed to create an even sharper delineation. Now, our user input is completely decoupled from our business logic, and both classes should be easier to change in the future.</p>

        </div>
      </div>

      <div class="pure-u-1">
        <div class="l-box">
          <hr />
          <p class="footer">
            &copy; 2022 <strong>Alex Taylor</strong>
            &middot;
            <a href="https://github.com/mctaylorpants">github</a>
            &middot;
            <a href="https://www.linkedin.com/in/alexmorgantaylor/">linkedin</a>
            &middot;
            <a href="https://twitter.com/mctaylorpants">twitter</a>
            &middot;
            <a rel="me" href="https://ruby.social/@alextaylor">mastodon</a>
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
